## 项目整合Jedis

### 环境搭建
1. 添加pom
```xml
<dependency>
	<groupId>redis.clients</groupId>
	<artifactId>jedis</artifactId>
</dependency>
```

2. 创建一个管理redis连接池的对象
```java
/**
 * redis连接池
 * @author whoiszxl
 *
 */
public class RedisPool {

	/**
	 * jedis连接池
	 */
	private static JedisPool pool;
	/**
	 * 最大连接数
	 */
	private static Integer maxTotal = Integer.parseInt(PropertiesUtil.getProperty("redis.max.total","20"));
	
	/**
	 * 在jedisPool中最大的idle状态（空闲）的jedis实例的个数
	 */
	private static Integer maxIdle = Integer.parseInt(PropertiesUtil.getProperty("redis.max.idle","20"));
	
	/**
	 * 在jedisPool中最小的idle状态（空闲）的jedis实例的个数
	 */
	private static Integer minIdle = Integer.parseInt(PropertiesUtil.getProperty("redis.min.idle","5"));

	/**
	 * 在borrow一个jedis实例时，是否要进行验证操作，
	 * 如果赋值为true，则得到的jedis实例是必定可以使用的
	 */
	private static Boolean testOnBorrow = Boolean.parseBoolean(PropertiesUtil.getProperty("redis.test.borrow","true"));
	
	/**
	 * 在return一个jedis实例时，是否要进行验证操作，
	 * 如果赋值为true，则返回的jedis实例是必定可以使用的
	 */
	private static Boolean testOnReturn = Boolean.parseBoolean(PropertiesUtil.getProperty("redis.test.return","true"));
	
	/**
	 * redis ip地址
	 */
	private static String redisIp = PropertiesUtil.getProperty("redis.ip");
	
	/**
	 * redis 端口
	 */
	private static Integer redisPort = Integer.parseInt(PropertiesUtil.getProperty("redis.port"));
	
	/**
	 * redis 密码
	 */
	private static String redisPass = PropertiesUtil.getProperty("redis.password");
	
	private static void initPool() {
		JedisPoolConfig config = new JedisPoolConfig();
		config.setMaxTotal(maxTotal);
		config.setMaxIdle(maxIdle);
		config.setMinIdle(minIdle);
		config.setTestOnBorrow(testOnBorrow);
		config.setTestOnReturn(testOnReturn);
		
		config.setBlockWhenExhausted(true);//连接耗尽时是否阻塞，false抛出异常，默认true
		
		pool = new JedisPool(config, redisIp, redisPort, 2*1000, redisPass);
	}
	
	static {
		initPool();
	}
	
	public static Jedis getJedis() {
		return pool.getResource();
	}
	
	public static void returnResource(Jedis jedis) {
		if(jedis != null) {
			pool.close();
		}
	}
	
	public static void main(String[] args) {
		Jedis jedis = pool.getResource();
		String string = jedis.get("girl");
		System.out.println(string);
		returnResource(jedis);
		pool.destroy();
		System.out.println("end");
	}
}
```

### Redis API操作工具
```java
public class RedisPoolUtil {
	
	private static Logger log = LoggerFactory.getLogger(RedisPoolUtil.class);
	
	/**
	 * 重新设置key的有效期
	 * @param key 键
	 * @param exTime 有效时间（秒）
	 * @return 还剩多少时间
	 */
	public static Long expire(String key, int exTime) {
		Jedis jedis = null;
		Long result = null;
		
		try {
			jedis = RedisPool.getJedis();
			result = jedis.expire(key, exTime);
			RedisPool.returnResource(jedis);
		} catch (Exception e) {
			log.error("expire key:{} time:{} error", key, exTime, e);
			return result;
		}
		return result;
	}
	
	/**
	 * 设置倒计时失效的键值
	 * @param key 键
	 * @param value 值
	 * @param exTime 秒数
	 * @return 是否设置成功
	 */
	public static String setEx(String key, String value, int exTime) {
		Jedis jedis = null;
		String result = null;
		
		try {
			jedis = RedisPool.getJedis();
			result = jedis.setex(key, exTime, value);
			RedisPool.returnResource(jedis);
		} catch (Exception e) {
			log.error("setex key:{} time:{} value:{} error", key, exTime, value, e);
			return result;
		}
		return result;
	}
	
	/**
	 * 设置redis值
	 * @param key 键
	 * @param value 值
	 * @return 是否设置成功
	 */
	public static String set(String key, String value) {
		Jedis jedis = null;
		String result = null;
		
		try {
			jedis = RedisPool.getJedis();
			result = jedis.set(key, value);
			RedisPool.returnResource(jedis);
		} catch (Exception e) {
			log.error("set key:{} value:{} error", key, value, e);
			return result;
		}
		return result;
	}
	
	/**
	 * 获取redis值
	 * @param key 键
	 * @return 值
	 */
	public static String get(String key) {
		Jedis jedis = null;
		String result = null;
		
		try {
			jedis = RedisPool.getJedis();
			result = jedis.get(key);
			RedisPool.returnResource(jedis);
		} catch (Exception e) {
			log.error("get key:{} error", key, e);
			return result;
		}
		return result;
	}
	
	/**
	 * 删除一个键值对
	 * @param key 键
	 * @return 是否成功
	 */
	public static Long del(String key) {
		Jedis jedis = null;
		Long result = null;
		
		try {
			jedis = RedisPool.getJedis();
			result = jedis.del(key);
			RedisPool.returnResource(jedis);
		} catch (Exception e) {
			log.error("del key:{} error", key, e);
			return result;
		}
		return result;
	}
	
}
```

### json序列化工具
1. 添加依赖
```xml
<dependency>
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-mapper-asl</artifactId>
    <version>1.9.12</version>
</dependency>
```

2. 代码
```java
public class JsonUtil {
	
	private static Logger log = LoggerFactory.getLogger(JsonUtil.class);
	
    private static ObjectMapper objectMapper = new ObjectMapper();
    static{
        //对象的所有字段全部列入
        objectMapper.setSerializationInclusion(Inclusion.ALWAYS);

        //取消默认转换timestamps形式
        objectMapper.configure(SerializationConfig.Feature.WRITE_DATES_AS_TIMESTAMPS,false);

        //忽略空Bean转json的错误
        objectMapper.configure(SerializationConfig.Feature.FAIL_ON_EMPTY_BEANS,false);

        //所有的日期格式都统一为以下的样式，即yyyy-MM-dd HH:mm:ss
        objectMapper.setDateFormat(new SimpleDateFormat(DateTimeUtil.STANDARD_FORMAT));

        //忽略 在json字符串中存在，但是在java对象中不存在对应属性的情况。防止错误
        objectMapper.configure(DeserializationConfig.Feature.FAIL_ON_UNKNOWN_PROPERTIES,false);
    }


    /**
     * 对象序列化
     * @param obj
     * @return
     */
    public static <T> String obj2String(T obj){
        if(obj == null){
            return null;
        }
        try {
            return obj instanceof String ? (String)obj :  objectMapper.writeValueAsString(obj);
        } catch (Exception e) {
            log.warn("Parse Object to String error",e);
            return null;
        }
    }

    /**
     * 序列一个有格式的字符串
     * @param obj
     * @return
     */
    public static <T> String obj2StringPretty(T obj){
        if(obj == null){
            return null;
        }
        try {
            return obj instanceof String ? (String)obj :  objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(obj);
        } catch (Exception e) {
            log.warn("Parse Object to String error",e);
            return null;
        }
    }




    /**
     * 反序列化
     * @param str
     * @param clazz
     * @return
     */
    public static <T> T string2Obj(String str,Class<T> clazz){
        if(StringUtils.isEmpty(str) || clazz == null){
            return null;
        }

        try {
            return clazz.equals(String.class)? (T)str : objectMapper.readValue(str,clazz);
        } catch (Exception e) {
            log.warn("Parse String to Object error",e);
            return null;
        }
    }



    /**
     * 反序列化
     * @param str
     * @param typeReference
     * @return
     */
    public static <T> T string2Obj(String str, TypeReference<T> typeReference){
        if(StringUtils.isEmpty(str) || typeReference == null){
            return null;
        }
        try {
            return (T)(typeReference.getType().equals(String.class)? str : objectMapper.readValue(str,typeReference));
        } catch (Exception e) {
            log.warn("Parse String to Object error",e);
            return null;
        }
    }


    public static <T> T string2Obj(String str,Class<?> collectionClass,Class<?>... elementClasses){
        JavaType javaType = objectMapper.getTypeFactory().constructParametricType(collectionClass,elementClasses);
        try {
            return objectMapper.readValue(str,javaType);
        } catch (Exception e) {
            log.warn("Parse String to Object error",e);
            return null;
        }
    }

}
```