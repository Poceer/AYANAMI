## 项目环境架构
1. 前台通过两台nginx指向四个前端node项目
2. 前端四个node项目再通过两个nginx指向四个后端项目
3. 后端项目通过两个HA指向四个MySQL
4. 同时后端依赖三个Redis节点搭建的集群

## docker常用命令

### 基本命令
1. `yum install update` 更新软件包
2. `yum install -y docker` 安装docker软件
3. `service docker start|restart|stop` 开启|重启|停止 docker服务
4. `docker search image_name` 搜索镜像
5. `docker pull image_name` 下载镜像
6. `docker images` 查看镜像
7. `docker rmi image_name` 删除镜像 
8. `docker run 启动参数 镜像名称` 运行容器
9. `docker ps -a` 查看容器列表
10. `docker stop|pause|unpause 容器ID` 停止|挂起|恢复 容器
11. `docker inspect 容器ID` 查看容器信息
12. `docker rm 容器ID` 删除容器
13. `docker volume create|rm|inspect 数据卷名称` 创建|删除|查看 数据卷
14. `docker network ls` 查看网络信息
15. `docker network create --subnet=网段 网络名称` 创建一个网络
16. `docker network rm 网络名称` 移除网络

### 组合命令
1. `docker rmi $(docker images | grep "none" | awk '{print $3}')` 删除所有为none的无效镜像，去除grep的过滤后可以删除所有的镜像


## docker搭建MySQL集群

### 集群方案介绍
1. 使用`PXC(Percona XtraDB Cluster)`,使用PerconaServer(MySQL改进版，性能提升很大)
2. `PXC集群方案`读写是双向的，每个节点都能读写
3. `PXC`数据`强一致性`，在一个节点写入了数据，还需要将数据`同步到其它节点`，`提交事务`后才生效

### PXC集群安装
1. 在docker中安装PXC镜像：`docker pull percona/percona-xtradb-cluster`
2. 为PXC镜像改名: `docker tag percona/percona‐xtradb‐cluster pxc`
3. 创建net1网段：`docker network create ‐‐subnet=172.18.0.0/16 net1`
4. 创建5个数据卷：`docker volume create --name v1|v2|v3|v4|v5`
5. 创建一个备份卷：`docker volume create --name backup`
6. 创建一个5节点PXC集群,`MYSQL_ROOT_PASSWORD`指定root密码，`CLUSTER_NAME`指定集群名称，`XTRABACKUP_PASSWORD`为节点间同步密码，`-v`指定数据卷映射，宿主机与docker目录对应,`--privileged` 指定最高权限，`--name`为节点命令，`--net`指定网络，`--ip`指定当前节点ip，最后的`pxc`为镜像名称
```shell
#创建第1个MySQL节点
docker run -d -p 3316:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=net1 --ip 172.18.0.2 pxc
#创建第2个MySQL节点
docker run -d -p 3326:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v2:/var/lib/mysql --privileged --name=node2 --net=net1 --ip 172.18.0.3 pxc
#创建第3个MySQL节点
docker run -d -p 3336:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v3:/var/lib/mysql --privileged --name=node3 --net=net1 --ip 172.18.0.4 pxc
#创建第4个MySQL节点
docker run -d -p 3346:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v4:/var/lib/mysql --privileged --name=node4 --net=net1 --ip 172.18.0.5 pxc
#创建第5个MySQL节点
docker run -d -p 3356:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v5:/var/lib/mysql --privileged --name=node5 --net=net1 --ip 172.18.0.6 pxc

# 通过将2,3,4,5节点连接到1节点，形成PXC集群，五个节点都可读可写
```

### 数据库负载均衡
虽然有集群了，但是单节点请求的话还是负载高，性能差，所以需要`负载均衡`了

1. 安装haproxy镜像: `docker pull haproxy`
2. 创建一个无权限MySQL用户，用作haproxy的心跳监控：`create user 'haproxy'@'%' IDENTIFIED BY '';`
3. 在宿主机上编写Haproxy配置文件
```properties
global
	#工作目录
	chroot /usr/local/etc/haproxy
	#日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info
	log 127.0.0.1 local5 info
	#守护进程运行
	daemon

defaults
	log	global
	mode	http
	#日志格式
	option	httplog
	#日志中不记录负载均衡的心跳检测记录
	option	dontlognull
    #连接超时（毫秒）
	timeout connect 5000
    #客户端超时（毫秒）
	timeout client  50000
	#服务器超时（毫秒）
    timeout server  50000

#监控界面	
listen  admin_stats
	#监控界面的访问的IP和端口
	bind  0.0.0.0:8888
	#访问协议
    mode        http
	#URI相对地址
    stats uri   /dbs
	#统计报告格式
    stats realm     Global\ statistics
	#登陆帐户信息
    stats auth  admin:abc123456
#数据库负载均衡
listen  proxy-mysql
	#访问的IP和端口
	bind  0.0.0.0:3306  
    #网络协议
	mode  tcp
	#负载均衡算法（轮询算法）
	#轮询算法：roundrobin
	#权重算法：static-rr
	#最少连接算法：leastconn
	#请求源IP算法：source 
    balance  roundrobin
	#日志格式
    option  tcplog
	#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测
    option  mysql-check user haproxy
    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  
    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  
	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 
	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000
	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000
	#使用keepalive检测死链
    option  tcpka  
```
4. 创建两个Haproxy容器
```shell
#创建第1个Haproxy负载均衡服务器
docker run -it -d -p 4001:8888 -p 4002:3306 -v /home/soft/haproxy:/usr/local/etc/haproxy --name h1 --privileged --net=net1 --ip 172.18.0.7 haproxy
#进入h1容器，启动Haproxy
docker exec -it h1 bash
haproxy -f /usr/local/etc/haproxy/haproxy.cfg


#创建第2个Haproxy负载均衡服务器
docker run -it -d -p 4003:8888 -p 4004:3306 -v /home/soft/haproxy:/usr/local/etc/haproxy --name h2 --privileged --net=net1 --ip 172.18.0.8 haproxy
#进入h2容器，启动Haproxy
docker exec -it h2 bash
haproxy -f /usr/local/etc/haproxy/haproxy.cfg
```